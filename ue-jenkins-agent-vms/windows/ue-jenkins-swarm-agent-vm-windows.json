{
  "builders": [
    {
      "type": "googlecompute",
      "project_id": "{{user `project_id`}}",
      "source_image": "{{user `source_image`}}",
      "disable_default_service_account": true,
      "disk_size": "50",
      "disk_type": "pd-ssd",
      "communicator": "winrm",
      "image_name": "{{user `image_name`}}",
      "network": "{{user `network`}}",
      "state_timeout": "10m",
      "subnetwork": "{{user `subnetwork`}}",
      "winrm_username": "packer_user",
      "winrm_insecure": true,
      "winrm_use_ssl": true,
      "metadata": {
        "windows-startup-script-cmd": "winrm quickconfig -quiet & net user /add packer_user & net localgroup administrators packer_user /add & winrm set winrm/config/service/auth @{Basic=\"true\"}"
      },
      "zone": "{{user `zone`}}"
    }
  ],
  "provisioners": [
    {
      "type": "file",
      "source": "ImageCreation",
      "destination": "C:\\"
    },
    {
      "type": "file",
      "source": "Runtime",
      "destination": "C:\\"
    },
    {
      "type": "powershell",
      "inline": "try { C:\\ImageCreation\\Scripts\\InstallSoftware.ps1 } catch { Write-Error $_; exit 1 }"
    },
    {
      "type": "powershell",
      "inline": "try { C:\\ImageCreation\\Scripts\\GCERegisterService-SwarmAgent.ps1 } catch { Write-Error $_; exit 1 }"
    },
    {
      "type": "powershell",
      "inline": "exit (Invoke-Pester -Script C:\\ImageCreation\\Scripts\\VerifyInstance.ps1 -PassThru).FailedCount"
    },
    {
      "type": "powershell",
      "inline": "Remove-Item -Force -Recurse C:\\ImageCreation"
    }
  ],
  "variables": {
    "project_id": "",
    "zone": "",
    "network": "",
    "subnetwork": "",
    "source_image": "windows-server-2019-dc-core-for-containers-v20210309",
    "image_name": ""
  }
}
